\begin{lstlisting}[language=lean]
def book_seller (negotiate: negT buyer ep)
  : Choreo ep (Option (String @ buyer # ep)) := do

  let budget <- locally buyer do get_budget
  let title <- locally buyer do get_title

  let title' <- (title ~> seller)
  let price <- locally seller do lookup_price (⤉title')
  let price <- price ~> buyer

  locally seller do info s!"got book title: {⤉title'}"

  locally buyer do info s!"the price is {⤉price}, negotiate with friend"

  let d <- negotiate budget price -- calls another choreo :)

  branch d fun
  | true => do
    let date <- locally seller do deliveryDate
    let date <- date ~> buyer
    return some date
  | false => do
    locally seller do warning s!"the customer declined the purchase"
    locally buyer do error s!"{⤉title} has a price of {⤉price} exceeding your budget of {⤉budget}!"
    return none

\end{lstlisting}
